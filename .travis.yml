sudo: required
dist: trusty
language: cpp
services:
  - docker

cache:
  directories:
    - $HOME/builder_ccache
    - $HOME/full_build
    - $HOME/proof-bin

env:
  global:
    - TARGET_NAME=`echo "$TRAVIS_REPO_SLUG" | sed -r 's|(.*/)?(.+)|\2|'`
    - PATH=$HOME/.local/bin:$PATH
    - secure: "qJFKsOWu5pBhmjgW0PwplmAeZrNe13d82oBXtXatHlfaQEVZnJZ+ecqjtGcqYSpXi9EdWKI9UwAYUB9rfnqXeCbtNb9ryjchZrnNsyruaoRPuloJnTvZKWxE+X+vCz3kKu2dY+Zh9h51guf++JhfAx7MRappuFqIHZvAoe6gAYmRcjdLfwoR27znHn2cf6EMuWpOdwUJf5n0l3WpyUdY/uxRYUC/suuVy1PvkaPKJOvCrI0Bl1moIXcwlVExujsMQ2kHI0rhFgTlDglmM1wMjsCrmQYEtG3OwC8xOQJCV221pZTrjQ7RlsceEvRe1XpdwcISIdBF6/0Rhn9k8D2YOl54ayERoF/5xvSeg3AdeawYh87dExYdrTnIopEvP6FgtopeO5fB+l/fiQPgKog6jRiBjR5smzvevZyN/3b+XkYqj3HDHIJ3IO+nrtQM+ssirfDOtBUqaLXNI9o2VIf0rPAhkg8d1D0sOoFGqUYttI9QYcYdKE/XxSfPhAc4uIrifjcSkFJjXqx4HekR0nZOzP2ySHVoVPlhhKOyC+EtpV96Gg6oveKRrylj6H7MO40zeVdWpULQ3qhZhrDKDpvdkpCojJnHV1cXYvxRWkeD7vt3fZlFn+zejD3PsvVoibhBP79wkKGyhge+r7z1Smey54251dtA9tI7GQJC6nQVGVs="
    - secure: "htUAjP0Xk5S3ZwiR8m/TVnudsFc9UtRJKqIfADmAhDhY1OOkVSyL50AwpbwA6bekUMqUdyfsZEgH70U4gGLBAm1X2/FUxRuCuvskUb31Mys9brHtr7Ye2knDV4T7u1OW0DS7G/UBXQAzuzhXCaI+BcKr4ie1fs+quii7QXmn0q4eAwfP3gtOiiwUc73MeqqnxdHOGjSOty28C9vaYqcd69N8rRtEoknjuWDmOQjY4J66EGrcBcESOyy1ozP/eBNwQ+kFJ0ilWDFBW+Jtw2zmamUKJYClzb8aPvo9KN8nceeZEJmQa6p4+D87Zf3xe3g5KK86e+x3ikHSw3co1OEc+/iWniLnEWIZfnQVJ0tryMYWeMtZeMFpJC2MYe4B2ncuUblsusZj3/K9HbDvQY7fOJeHzY/IQLeoEql1C8fvz8vjqWYIUIq7zgPkQ1IZIUfvT/BvzOPus9g9RaOS9fmDjjFF5aQilDfNvAO8h6ms8LOFGgjtF2KhaD+ebRWYqUaq2SLV9y3Hb92xIMu9T/InwWFT9YI5gylh0uXzaeway+oc4dDkCCY4u88WSrhnMxbSL9SBjvG3Ze013Vq4YfoVhiWNYr26S0fj6neZtT3J57CZpSCSrOAKIsssBkRPvbeMQHRkLadxAjh93aSLEYgYvoZA9uiO83wi4TY8MYsp7QU="
    - secure: "DYnWBX3nTc99iT9chRFOExPFChOnEV4sEje6MBcLNJbsw0FMH3aevm3YU9YqwBmf9vM4D138K9XTRqUaxCUGXIzXRjAa73UJCsUmZn51KWDc5YUEIfObHxzhdzweYmBCdvLjFJLH2sjrB4UzORlrnatRH5+J0Lp4oik4WE6/ge5VfiTI3wfaMSpZARvw/lEIzARweKmttU3xHmufJA0vqQtHz8U6FtlQKHDLoPPSNuf5H3WqWT/ibG76cC35U/3tzVCZFRkJ+nhrKFw/vws0svIpz9Sxyd3mtTcYH/afm0mUQyTPOdzthGpcjpI09YmOug+FMOXZrUjHUKxov1tAmBdkaOfFBazObAlu1S4QJc6slqJU+Mmm5sVT+Rd8TDkQEFHlbiz8WhkFHX6xxoKZbD0UjkGzp6J/3zgMv7GAsBz9dJNI1ZXvIL6H2C0bKzAkk+5b/knNfIsGx2zmeccgfCjGi7lYYaTLS0VxT+TGyIQ9zQzNcJLa3qMrNkF4gBWqcUXi9dVHT5ejt2PZEJguql/O+qIfx3rIyBFigYO3GQhuqgXzWrtyQRQRQXmhP2RJ93+y6jfZ3Xkqyrw1OlU32PPAF+ll/7dmbdauirLArFuU96uLkTdK+xtBPPxWxTqNk82ooEACxGvlyUV5u2TFjTNJ0yAZauCqae/lURGy72w="
    - secure: "UC/31j8sPpyVbOLz34DEb+Yms+XD67NUn1ykGvYOhZVsdwNYynuSbzrDmr/43tT3OdL1ItF4UKc8TzlN4NJdmNdb3noL1bYR3HpDDLweybptv7/wtkf/LkiVFVePKWvgBqfUP+Qaay7sO1Sfj7qI60c4aacrbNYQfQ82dJz7TIlt1eqqbLHnkwsqfK+2ubQl7vvbRlbtwL1rJ1FbQLZEn4vuJNizHKG4zqcsV7Gk7wFJmHxADpg1y3bm6J+uRDU0YYdw7IcjUgQyDSquMIXInCm3gVRHsHIAd3R7wjJmSX7NgD1DHfDCWN4IL2C4U19kYKjjVAdfoUn9zUS6EEFWWSdVMGCM2qWKImSuOgh7SFlzVZ23VQLeb6j6AJ7DwYWPJRDRlxI6DKbH0Q1y3y6uj5QkL4V4+v2pBtuAnwThbzqsRf5h+m+lsidQln/FVU79cmSTS2odlQs5vLmVTc42VIM5ggfNBYqrhW7dHhOKken4CINxjCU0QjAOlEXSktGH5Q9y3r/lYy3GLEkSl/oM0dp6zupp1Hd+sm1tptvfgYP5sFGd9VRy3mv2GhmVXJgP7nqkjynnP5CZbqBka9VahT4ZyFzTjZz1JfNUALftBbtrj9/RtfgYM+y0lQgMMqQF2Xx3JDw+t7ju/YhMkuGhf5Ec2CgjXBrKhNyKkZewHpo="

before_install: export -f travis_fold && export -f travis_time_start && export -f travis_time_finish && export -f travis_nanoseconds
script: echo "Nothing to do"

jobs:
  include:
    - &proof-boot
      stage: Proof boot
      name: Linux proofboot downloading
      if: type != pull_request AND tag IS blank AND branch != master
      before_script: pip install --user awscli
      script:
        - aws s3 cp s3://proof.travis.builds/$TRAVIS_BRANCH/raw-bin/proofboot-bin-debian9.tar.gz $HOME/proof-bin.tar.gz ||
          aws s3 cp s3://proof.travis.builds/develop/raw-bin/proofboot-bin-debian9.tar.gz $HOME/proof-bin.tar.gz || travis_terminate 1
        - cd $HOME && sudo rm -rf proof-bin && tar -xzf proof-bin.tar.gz
    - <<: *proof-boot
      stage: Proof boot
      name: Linux proofboot downloading for API compatibility check
      if: type != pull_request AND tag IS blank AND branch != master
      env: DUMMY=abi
      before_script: pip install --user awscli
      script:
        - aws s3 cp s3://proof.travis.builds/$TRAVIS_BRANCH/raw-bin/proofboot-bin-debian9.tar.gz $HOME/proof-bin.tar.gz ||
          aws s3 cp s3://proof.travis.builds/develop/raw-bin/proofboot-bin-debian9.tar.gz $HOME/proof-bin.tar.gz || travis_terminate 1
        - cd $HOME && sudo rm -rf proof-bin && tar -xzf proof-bin.tar.gz
    - <<: *proof-boot
      name: Android proofboot downloading
      if: type != pull_request AND tag IS blank AND branch != master
      language: android
      android:
        components:
          - build-tools-25.0.2
      env: DUMMY=android
      before_script: pip install --user awscli
      script:
        - aws s3 cp s3://proof.travis.builds/$TRAVIS_BRANCH/raw-bin/proofboot-bin-android.tar.gz $HOME/proof-bin.tar.gz ||
          aws s3 cp s3://proof.travis.builds/develop/raw-bin/proofboot-bin-android.tar.gz $HOME/proof-bin.tar.gz || travis_terminate 1
        - cd $HOME && sudo rm -rf proof-bin && tar -xzf proof-bin.tar.gz

    - &pre-compile
      stage: Proof dependencies
      name: Linux proof modules downloading
      if: type != pull_request AND tag IS blank AND branch != master
      script: $HOME/proof-bin/dev-tools/travis/proof-modules/pre-compile/raw-bin_download.sh debian9
    - <<: *pre-compile
      name: Linux proof modules downloading for API compatibility check
      if: type != pull_request AND tag IS blank AND branch != master
      env: DUMMY=abi
      script: $HOME/proof-bin/dev-tools/travis/proof-modules/pre-compile/raw-bin_download.sh debian9
    - <<: *pre-compile
      name: Android proof modules downloading
      language: android
      android:
        components:
          - build-tools-25.0.2
      env: DUMMY=android
      if: type != pull_request AND tag IS blank AND branch != master
      script: $HOME/proof-bin/dev-tools/travis/proof-modules/pre-compile/raw-bin_download.sh android

    - &compile
      stage: compilation and static checks
      name: Compilation (Debian9/clang/ccache)
      if: tag IS blank AND branch != master
      script: $HOME/proof-bin/dev-tools/travis/proof-modules/compile/linux_compile.sh
    - <<: *compile
      name: Code style check with clang-format
      script: $HOME/proof-bin/dev-tools/travis/proof-modules/compile/clang-format_check.sh
    - <<: *compile
      name: Static code analysis with clazy
      script: $HOME/proof-bin/dev-tools/travis/proof-modules/compile/clazy_check.sh
    - <<: *compile
      name: API compatibility check
      env: DUMMY=abi
      if: tag IS blank AND branch != master
      script: $HOME/proof-bin/dev-tools/travis/proof-modules/compile/abi_check.sh
    - <<: *compile
      name: Compilation (Android27/gcc/ccache)
      language: android
      android:
        components:
          - tools
          - platform-tools
          - tools
          - build-tools-27.0.3
          - android-27
      env: DUMMY=android
      if: tag IS blank AND branch != master
      script: $HOME/proof-bin/dev-tools/travis/proof-modules/compile/android_compile.sh

    - &unit-tests
      stage: unit tests
      name: tests/ProofUtils
      if: tag IS blank AND branch != master
      script: $HOME/proof-bin/dev-tools/travis/proof-modules/unit-tests/run_tests.sh utils
    - <<: *unit-tests
      name: tests/ProofNetworkMis
      if: tag IS blank AND branch != master
      script: $HOME/proof-bin/dev-tools/travis/proof-modules/unit-tests/run_tests.sh network-mis
    - <<: *unit-tests
      name: tests/ProofNetworkUms
      if: tag IS blank AND branch != master
      script: $HOME/proof-bin/dev-tools/travis/proof-modules/unit-tests/run_tests.sh network-ums
    - <<: *unit-tests
      name: tests/ProofNetworkLprPrinter
      if: tag IS blank AND branch != master
      script: $HOME/proof-bin/dev-tools/travis/proof-modules/unit-tests/run_tests.sh network-lprprinter

    - &post-compile
      stage: Post compilation
      name: Raw linux binary upload to S3
      if: type != pull_request AND tag IS blank AND branch != master
      script: $HOME/proof-bin/dev-tools/travis/proof-modules/post-compile/raw-bin_upload.sh debian9
    - <<: *post-compile
      name: Raw android binary upload to S3
      language: android
      android:
        components:
          - build-tools-25.0.2
      env: DUMMY=android
      if: type != pull_request AND tag IS blank AND branch != master
      script: $HOME/proof-bin/dev-tools/travis/proof-modules/post-compile/raw-bin_upload.sh android

    - &ping-dependants
      stage: Dependants builds
      name: Build request for all modules based on current one
      if: type != pull_request AND tag IS blank AND branch != master
      script: $HOME/proof-bin/dev-tools/travis/ping_dependants.sh
